<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printer Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/overlay.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/root.css') }}">
</head>
<body>
    <div class="bg-img"></div>
    <header>
        <h1>Printer Manager</h1>
        <div class="header-controls">
            <div class="dropdown" style="position:relative;">
                <button id="appearance-dropdown-btn" class="btn" aria-haspopup="true" aria-expanded="false" title="Appearance options">
                    ðŸŽ¨
                </button>

                <div id="appearance-dropdown" class="hidden" role="menu" aria-labelledby="appearance-dropdown-btn">
                    <div class="dropdown-item">
                        <div class="dropdown-item-label">
                            <strong>Theme</strong>
                            <small>Dark mode</small>
                        </div>
                        <label class="toggle">
                            <input id="theme-switch" type="checkbox" checked>
                            <span class="slider"><span></span></span>
                        </label>
                    </div>

                    <div id="glass-item" class="dropdown-item">
                        <div class="dropdown-item-label">
                            <strong>Glass</strong>
                            <small>Enable glass</small>
                        </div>
                        <label class="toggle">
                            <input id="glass-switch" type="checkbox" checked>
                            <span class="slider"><span></span></span>
                        </label>
                    </div>
                </div>

                <!-- Hidden legacy buttons kept for existing scripts to work -->
                <button id="theme-toggle" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;" aria-pressed="false" title="Toggle color theme">Toggle Theme</button>
                <button id="glass-btn" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;" aria-pressed="false" title="Enable glass look">Glass look</button>
            </div>

            <script>
                (function(){
                    const ddBtn = document.getElementById('appearance-dropdown-btn');
                    const menu = document.getElementById('appearance-dropdown');
                    const themeSwitch = document.getElementById('theme-switch');
                    const glassSwitch = document.getElementById('glass-switch');
                    const glassItem = document.getElementById('glass-item');
                    const themeBtn = document.getElementById('theme-toggle');
                    const glassBtn = document.getElementById('glass-btn');
                    const THEME_KEY = 'site-theme';
                    const GLASS_KEY = 'site-glass';

                    function open(){ menu.classList.remove('hidden'); ddBtn.setAttribute('aria-expanded','true'); }
                    function close(){ menu.classList.add('hidden'); ddBtn.setAttribute('aria-expanded','false'); }

                    ddBtn.addEventListener('click', e => {
                        e.stopPropagation();
                        menu.classList.contains('hidden') ? open() : close();
                    });

                    document.addEventListener('click', (e) => {
                        if (!menu.contains(e.target) && !ddBtn.contains(e.target)) close();
                    });

                    function applySliderVisual(input){
                        const slider = input.nextElementSibling;
                        if (!slider) return;
                        const knob = slider.firstElementChild;
                        if (input.checked){
                            slider.style.background = 'var(--accent,#0a84ff)';
                            knob.style.transform = 'translateX(18px)';
                        } else {
                            slider.style.background = '#444';
                            knob.style.transform = 'translateX(0)';
                        }
                    }

                    function setTheme(theme){
                        document.documentElement.setAttribute('data-theme', theme);
                        try { localStorage.setItem(THEME_KEY, theme); } catch(e){}
                        if (themeBtn) {
                            const isDark = theme === 'dark';
                            themeBtn.setAttribute('aria-pressed', String(isDark));
                            themeBtn.title = isDark ? 'Switch to Lyntr theme' : 'Switch to Dark theme';
                            themeBtn.textContent = isDark ? 'Dark' : 'Lyntr';
                        }
                    }

                    function disableGlassSilently(){
                        const link = document.getElementById('glass-stylesheet');
                        if (link) link.remove();
                        try { localStorage.setItem(GLASS_KEY, '0'); } catch(e){}
                        if (glassBtn) {
                            glassBtn.setAttribute('aria-pressed', 'false');
                            glassBtn.title = 'Enable glass look';
                            glassBtn.textContent = 'Glass look';
                        }
                    }

                    function enableGlassSilently(href){
                        if (!document.getElementById('glass-stylesheet')) {
                            const link = document.createElement('link');
                            link.rel = 'stylesheet';
                            link.href = href || (window.getComputedStyle(document.documentElement).getPropertyValue('--glass-stylesheet-href') || '');
                            link.id = 'glass-stylesheet';
                            document.head.appendChild(link);
                        }
                        try { localStorage.setItem(GLASS_KEY, '1'); } catch(e){}
                        if (glassBtn) {
                            glassBtn.setAttribute('aria-pressed', 'true');
                            glassBtn.title = 'Disable glass look';
                            glassBtn.textContent = 'Normal look';
                        }
                    }

                    function syncFromState(){
                        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                        themeSwitch.checked = isDark;
                        applySliderVisual(themeSwitch);

                        if (glassItem) {
                            glassItem.style.display = '';
                            glassItem.setAttribute('aria-hidden', 'false');
                        }

                        if (glassSwitch) {
                            glassSwitch.checked = !!document.getElementById('glass-stylesheet');
                            applySliderVisual(glassSwitch);
                        }
                    }

                    themeSwitch.addEventListener('change', () => {
                        applySliderVisual(themeSwitch);
                        setTheme(themeSwitch.checked ? 'dark' : 'lyntr');

                        if (!themeSwitch.checked && glassSwitch && glassSwitch.checked) {
                            if (glassBtn) {
                                if (document.getElementById('glass-stylesheet')) glassBtn.click();
                            } else {
                                disableGlassSilently();
                            }
                        }

                        setTimeout(syncFromState, 50);
                    });

                    if (glassSwitch) {
                        glassSwitch.addEventListener('change', () => {
                            applySliderVisual(glassSwitch);

                            const currentlyOn = !!document.getElementById('glass-stylesheet');
                            const wantOn = glassSwitch.checked;

                            if (wantOn) {
                                if (document.documentElement.getAttribute('data-theme') !== 'dark') {
                                    setTheme('dark');
                                }
                            }

                            if (glassBtn) {
                                if (wantOn !== currentlyOn) glassBtn.click();
                            } else {
                                if (wantOn && !currentlyOn) enableGlassSilently();
                                if (!wantOn && currentlyOn) disableGlassSilently();
                            }
                            setTimeout(syncFromState, 50);
                        });
                    }

                    const obs = new MutationObserver(syncFromState);
                    obs.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
                    obs.observe(document.head, { childList: true, subtree: true });

                    syncFromState();
                })();
            </script>
            <button id="overlay-editor-btn" class="btn primary" title="Open overlay editor">Overlay Editor</button>
        </div>
    </header>
    <script>
        (function(){
            const BTN_ID = 'glass-btn';
            const LINK_ID = 'glass-stylesheet';
            const HREF = "{{ url_for('static', filename='styles/glas.css') }}";
            const KEY = 'site-glass';
            const THEME_BTN_ID = 'theme-toggle';
            const btn = document.getElementById(BTN_ID);

            function setThemeToggleVisibility(show) {
                const themeBtn = document.getElementById(THEME_BTN_ID);
                if (!themeBtn) return;
                themeBtn.style.display = show ? '' : 'none';
            }

            function setState(on) {
                btn.setAttribute('aria-pressed', String(Boolean(on)));
                btn.title = on ? 'Disable glass look' : 'Enable glass look';
                btn.textContent = on ? 'Normal look' : 'Glass look';
                if (on) {
                    if (!document.getElementById(LINK_ID)) {
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = HREF;
                        link.id = LINK_ID;
                        document.head.appendChild(link);
                    }
                } else {
                    const link = document.getElementById(LINK_ID);
                    if (link) link.remove();
                }
                setThemeToggleVisibility(!on);
                try { localStorage.setItem(KEY, on ? '1' : '0'); } catch (e) {
                    console.log(e)
                }
            }

            btn.addEventListener('click', () => {
                const currentlyOn = !!document.getElementById(LINK_ID);
                setState(!currentlyOn);
            });

            // initialize from storage
            try {
                const stored = localStorage.getItem(KEY);
                setState(stored === '1');
            } catch (e) {}
        })();

        (function(){
            const btn = document.getElementById('theme-toggle');
            const root = document.documentElement;
            const KEY = 'site-theme';
            function apply(theme){
                root.setAttribute('data-theme', theme);
                const isDark = theme === 'dark';
                btn.setAttribute('aria-pressed', String(isDark));
                btn.title = isDark ? 'Switch to Lyntr theme' : 'Switch to Dark theme';
                btn.textContent = isDark ? 'Dark' : 'Lyntr';
            }
            let theme = localStorage.getItem(KEY) || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'lyntr');
            apply(theme);
            btn.addEventListener('click', () => {
                theme = root.getAttribute('data-theme') === 'dark' ? 'lyntr' : 'dark';
                localStorage.setItem(KEY, theme);
                apply(theme);
            });
        })();
    </script>

    <main class="container">
        <!-- Left Side -->
            <section class="panel current">
            <h2>Current Image</h2>
            <div class="current-box">
                <img src="{{ url_for('static', filename='images/Testpage.png') }}" class="image-preview" alt="Current image preview">
                <div class="image-info">
                    <p><strong>PC:</strong> Canstein1</p>
                    <p><strong>Plot:</strong> 10;4</p>
                    <p><strong>Overlay:</strong> overlayname</p>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress" style="width: 40%;"></div>
            </div>
            <small>Time left: 32s</small>
        </section>
        <section class="panel queue">
            <div class="panel-header">
                <h2>Queue</h2>
            </div>
            <div class="queue-list">
                <div class="queue-item">
                    <img src="{{ url_for('static', filename='images/preview.jpg') }}" class="queue-image" alt="IMG">
                    <div class="queue-info">
                        <p><strong>PC:</strong> Canstein1</p>
                        <p><strong>Plot:</strong> 10;4</p>
                        <p><strong>Overlay:</strong> overlayname</p>
                    </div>
                    <button class="btn primary">Print</button>
                </div>
                <div class="queue-item">
                    <img src="{{ url_for('static', filename='images/Testpage.png') }}" class="queue-image" alt="IMG">
                    <div class="queue-info">
                        <p><strong>PC:</strong> Canstein2</p>
                        <p><strong>Plot:</strong> 12;5</p>
                        <p><strong>Overlay:</strong> overlayname2</p>
                    </div>
                    <button class="btn primary">Print</button>
                </div>
                <div class="queue-item">
                    <img src="{{ url_for('static', filename='images/Testpage.png') }}" class="queue-image" alt="IMG">
                    <div class="queue-info">
                        <p><strong>PC:</strong> Canstein3</p>
                        <p><strong>Plot:</strong> 12;5</p>
                        <p><strong>Overlay:</strong> overlayname3</p>
                    </div>
                    <button class="btn primary">Print</button>
                </div>
                <div class="queue-item">
                    <img src="{{ url_for('static', filename='images/Testpage.png') }}" class="queue-image" alt="IMG">
                    <div class="queue-info">
                        <p><strong>PC:</strong> Canstein4</p>
                        <p><strong>Plot:</strong> 12;5</p>
                        <p><strong>Overlay:</strong> overlayname4</p>
                    </div>
                    <button class="btn primary">Print</button>
                </div>
                <div class="queue-item">
                    <img src="{{ url_for('static', filename='images/Testpage.png') }}" class="queue-image" alt="IMG">
                    <div class="queue-info">
                        <p><strong>PC:</strong> Canstein5</p>
                        <p><strong>Plot:</strong> 12;5</p>
                        <p><strong>Overlay:</strong> overlayname5</p>
                    </div>
                    <button class="btn primary">Print</button>
                </div>
                <div class="queue-item">
                    <img src="{{ url_for('static', filename='images/Testpage.png') }}" class="queue-image" alt="IMG">
                    <div class="queue-info">
                        <p><strong>PC:</strong> Canstein6</p>
                        <p><strong>Plot:</strong> 12;5</p>
                        <p><strong>Overlay:</strong> overlayname6</p>
                    </div>
                    <button class="btn primary">Print</button>
                </div>
            </div>
        </section>
        <!-- Right Side -->
        <section class="panel controls">
            <h2>Status: <span class="status-text printing">Printing</span></h2>
            <label class="toggle">
                <input type="checkbox" checked>
                <span class="slider"></span> Print On Receive
            </label>
            <div class="control-buttons">
                <button class="btn">Settings</button>
                <button class="btn">More</button>
                <button class="btn warning">Pause</button>
            </div>
            <div class="active-overlay">Active Overlay</div>
        </section>
        <section class="panel finished">
            <h2>Finished</h2>
            <div class="finished-list">
                <div class="finished-item">
                    <img src="{{ url_for('static', filename='images/preview.jpg') }}" class="finished-image" alt="IMG">
                    <div class="finished-info">
                        <p><strong>PC:</strong> Canstein3</p>
                        <p><strong>Plot:</strong> 14;6</p>
                    </div>
                </div>
                <div class="finished-item">
                    <img src="{{ url_for('static', filename='images/preview.jpg') }}" class="finished-image" alt="IMG">
                    <div class="finished-info">
                        <p><strong>PC:</strong> Canstein3</p>
                        <p><strong>Plot:</strong> 14;6</p>
                    </div>
                </div>
                <div class="finished-item">
                    <img src="{{ url_for('static', filename='images/preview.jpg') }}" class="finished-image" alt="IMG">
                    <div class="finished-info">
                        <p><strong>PC:</strong> Canstein3</p>
                        <p><strong>Plot:</strong> 14;6</p>
                    </div>
                </div>
                <div class="finished-item">
                    <img src="{{ url_for('static', filename='images/preview.jpg') }}" class="finished-image" alt="IMG">
                    <div class="finished-info">
                        <p><strong>PC:</strong> Canstein3</p>
                        <p><strong>Plot:</strong> 14;6</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Overlay Editor Container -->
    <div id="overlay-editor-container" class="overlay-editor-container hidden">
        <div class="overlay-editor">
            <div class="overlay-editor-header">
                <h2>Overlay Editor</h2>
                <button class="btn import-btn" title="Import template" aria-label="Import template">ðŸ“¥</button>
                <button class="btn export-btn" title="Export template" aria-label="Export template">ðŸ“¤</button>
                <div class="export-wrapper hidden">
                    <div style="display:flex;align-items:center;gap:.5rem;">
                        <label for="export-filename">Filename:</label>
                    </div>
                    <input type="text" id="export-filename" placeholder="overlayname.json">
                    <button class="btn primary export-confirm-btn" type="button">Save</button>
                    <label class="toggle" title="Save exported template to server">
                        <span style="margin-left:.5rem;margin-right:.5rem;font-size:14px;">Save to server?</span>
                        <input id="save-to-server" type="checkbox" checked>
                        <span class="slider"><span></span></span>
                    </label>
                </div>
                <button id="close-overlay-editor" class="btn" title="Close Overlay Editor">&times;</button>
            </div>

            <div class="overlay-editor-content">
                <!-- Stage -->
                <div id="overlay-stage" class="overlay-stage">
                    <img id="overlay-image" src="{{ url_for('static', filename='images/Testpage.png') }}" alt="Overlay Preview" class="overlay-image">
                    <div id="overlay-layer" class="overlay-layer" aria-label="Overlay elements layer"></div>
                </div>

                <!-- Controls -->
                <div class="overlay-controls">
                    <div class="form-row" style="align-items:center; gap:1rem;">
                        <div class="form-group" style="flex:1">
                            <button class="btn primary add-text">Add Text</button>
                        </div>
                        <div class="form-group" style="flex:2">
                            <small>Placeholders: %plotid%, %pc%, ...</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="text-content">Text</label>
                        <input id="text-content" type="text" placeholder="Edit selected text">
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex:1">
                            <label for="font-family">Font</label>
                            <select id="font-family">
                                <option value="'Minecraft', 'Minecraftia', system-ui, sans-serif">Minecraft</option>
                                <option value="Inter, system-ui, sans-serif">Inter</option>
                                <option value="Arial, Helvetica, sans-serif">Arial</option>
                                <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
                                <option value="'Times New Roman', Times, serif">Times New Roman</option>
                                <option value="Georgia, serif">Georgia</option>
                                <option value="'Courier New', Courier, monospace">Courier New</option>
                            </select>
                        </div>

                        <div class="form-group" style="width:110px">
                            <label for="font-size">Size</label>
                            <input id="font-size" type="number" min="8" max="300" step="1" value="24">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex:1">
                            <label>Text Color</label>
                            <div style="display:flex;gap:.5rem;align-items:center">
                                <input id="text-color" type="color" value="#ffffff">
                                <input id="text-alpha" type="range" min="0" max="1" step="0.01" value="1" title="Text alpha">
                            </div>
                        </div>

                        <div class="form-group" style="flex:1">
                            <label>Background</label>
                            <div style="display:flex;gap:.5rem;align-items:center">
                                <input id="bg-color" type="color" value="#000000">
                                <input id="bg-alpha" type="range" min="0" max="1" step="0.01" value="0" title="Background alpha">
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex:1">
                            <label for="text-align">Align</label>
                            <select id="text-align">
                                <option value="left">Left</option>
                                <option value="center">Center</option>
                                <option value="right">Right</option>
                            </select>
                        </div>

                        <div class="form-group" style="flex:1">
                            <label for="rotation">Rotation</label>
                            <input id="rotation" type="range" min="-180" max="180" step="1" value="0">
                        </div>

                        <div class="form-group" style="flex:1">
                            <label for="opacity">Opacity</label>
                            <input id="opacity" type="range" min="0" max="1" step="0.05" value="1">
                        </div>
                    </div>

                    <div class="form-row" style="gap:.5rem">
                        <div class="form-group" style="flex:1;display:flex;gap:.5rem">
                            <button id="toggle-bold" class="btn" title="Toggle bold">Bold</button>
                            <button id="toggle-italic" class="btn" title="Toggle italic">Italic</button>
                            <button id="toggle-underline" class="btn" title="Toggle underline">Underline</button>
                        </div>

                        <div class="form-group" style="display:flex;gap:.5rem">
                            <button id="bring-forward" class="btn" title="Bring forward">Bring Forward</button>
                            <button id="send-backward" class="btn" title="Send backward">Send Backward</button>
                            <button id="delete-text" class="btn danger" title="Delete selected">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Templates Panel -->
        <div id="overlay-search-panel" class="overlay-search open">
            <button class="collapse-toggle" type="button" title="Collapse templates panel" aria-label="Collapse templates panel" aria-expanded="true"></button>
            <h3>Templates</h3>
            <ul class="overlay-templates-list">
                {% if overlay_templates %}
                    {% for tpl in overlay_templates %}
                        <li class="template-item" data-json="{{ url_for('static', filename='overlay-templates/' ~ tpl) }}">
                            <div class="template-preview" style="margin-bottom:.5rem;">
                                <div class="overlay-stage" style="position:relative; overflow:hidden;">
                                    <img src="{{ url_for('static', filename='images/Testpage.png') }}" alt="Template preview" class="overlay-image" style="display:block; width:100%; height:auto;">
                                    <div class="overlay-layer" style="position:absolute; inset:0;"></div>
                                </div>
                            </div>

                            <a href="{{ url_for('static', filename='overlay-templates/' ~ tpl) }}" target="_blank" rel="noopener">{{ tpl }}</a>
                            <button class="btn small import-template" data-file="{{ tpl }}" title="Import template">Import</button>
                            <script>
                            (function(){
                                const li = document.currentScript.closest('.template-item');
                                if (!li) return;
                                const jsonUrl = li.dataset.json;
                                const layer = li.querySelector('.overlay-layer');

                                function createNode(d){
                                    const node = document.createElement('div');
                                    node.className = 'text-node';
                                    node.textContent = d.text || '';

                                    if (typeof d.left === 'number') node.style.left = d.left + 'px'; else if (d.left) node.style.left = d.left;
                                    if (typeof d.top  === 'number') node.style.top  = d.top  + 'px'; else if (d.top)  node.style.top  = d.top;

                                    node.style.position = 'absolute';
                                    if (d.width)  node.style.width  = (typeof d.width  === 'number' ? d.width  + 'px' : d.width);
                                    if (d.height) node.style.height = (typeof d.height === 'number' ? d.height + 'px' : d.height);
                                    if (d.zIndex) node.style.zIndex = String(d.zIndex);

                                    if (d.fontFamily) node.style.fontFamily = d.fontFamily;
                                    if (d.fontSize)   node.style.fontSize   = (typeof d.fontSize === 'number' ? d.fontSize + 'px' : d.fontSize);
                                    if (d.color)      node.style.color      = d.color;
                                    if (d.backgroundColor) node.style.backgroundColor = d.backgroundColor;
                                    if (d.textAlign)  node.style.textAlign  = d.textAlign;
                                    if (d.rotate != null) {
                                        const r = (typeof d.rotate === 'string' && d.rotate.includes('deg')) ? d.rotate : d.rotate + 'deg';
                                        node.style.rotate = r;
                                        node.style.transform = 'rotate(' + String(r).replace('deg','') + 'deg)';
                                    }
                                    if (d.opacity != null) node.style.opacity = String(d.opacity);
                                    if (d.fontWeight) node.style.fontWeight = d.fontWeight;
                                    if (d.fontStyle)  node.style.fontStyle  = d.fontStyle;
                                    if (d.textDecoration) node.style.textDecoration = d.textDecoration;

                                    node.style.pointerEvents = 'none';
                                    layer.appendChild(node);
                                }

                                fetch(jsonUrl, { cache: 'no-store' })
                                    .then(r => r.ok ? r.json() : null)
                                    .then(obj => {
                                        if (!obj || !Array.isArray(obj.nodes)) return;
                                        obj.nodes.forEach(createNode);
                                    })
                                    .catch(() => {});

                                const importBtn = li.querySelector('.import-template');
                                if (importBtn) {
                                    importBtn.addEventListener('click', async () => {
                                        try {
                                            const res = await fetch(jsonUrl, { cache: 'no-store' });
                                            if (!res.ok) return alert('Failed to load template.');
                                            const obj = await res.json();
                                            if (window.overlayEditor && typeof window.overlayEditor.importObject === 'function') {
                                                window.overlayEditor.importObject(obj);
                                            } else {
                                                alert('Overlay editor not ready.');
                                            }
                                        } catch (e) {
                                            alert('Failed to import template.');
                                        }
                                    });
                                }
                            })();
                            </script>
                            <button class="btn small danger delete-template" data-file="{{ tpl }}" title="Delete template">Delete</button>
                            <script>
                            (function(){
                                const li = document.currentScript.closest('.template-item');
                                if (!li) return;
                                const delBtn = li.querySelector('.delete-template');
                                if (!delBtn) return;

                                delBtn.addEventListener('click', async () => {
                                    const file = delBtn.dataset.file;
                                    if (!file) return;
                                    if (!confirm('Delete template "' + file + '"? This cannot be undone.')) return;

                                    delBtn.disabled = true;
                                    const prevText = delBtn.textContent;
                                    delBtn.textContent = 'Deleting...';

                                    try {
                                        const res = await fetch('/api/delete-template/' + encodeURIComponent(file), { method: 'DELETE' });
                                        if (res.status === 204) {
                                            li.remove();
                                        } else if (res.status === 404) {
                                            alert('Template not found: ' + file);
                                            delBtn.disabled = false;
                                            delBtn.textContent = prevText;
                                        } else {
                                            const msg = await res.text().catch(() => res.statusText || 'Error');
                                            alert('Failed to delete template: ' + (msg || res.status));
                                            delBtn.disabled = false;
                                            delBtn.textContent = prevText;
                                        }
                                    } catch (e) {
                                        alert('Error deleting template.');
                                        delBtn.disabled = false;
                                        delBtn.textContent = prevText;
                                    }
                                });
                            })();
                            </script>
                        </li>
                    {% endfor %}
                {% else %}
                    <li class="empty">No templates found!</li>
                {% endif %}
            </ul>
        </div>
    </div>

    <script>
        (function(){
            const KEY = 'overlayTemplatesCollapsed';
            const panel = document.getElementById('overlay-search-panel') || document.querySelector('.overlay-search');
            if (!panel) return;
            const toggle = panel.querySelector('.collapse-toggle');
            if (!toggle) return;

            panel.classList.add('open');

            function applyState(collapsed){
                panel.classList.toggle('collapsed', collapsed);
                toggle.setAttribute('aria-expanded', String(!collapsed));
                toggle.title = collapsed ? 'Expand templates panel' : 'Collapse templates panel';
            }

            let collapsed = false;
            try { collapsed = localStorage.getItem(KEY) === '1'; } catch(e){}
            applyState(collapsed);

            toggle.addEventListener('click', () => {
                collapsed = !panel.classList.contains('collapsed');
                applyState(collapsed);
                try { localStorage.setItem(KEY, collapsed ? '1' : '0'); } catch(e){}
            });
        })();
    </script>

    <footer class="site-footer" role="contentinfo" style="padding:0.75rem 1rem;text-align:center;font-size:.85rem;color:var(--muted,#999);">
        <small>Website by <strong>nino.css</strong> Â· API by <strong>Hasenzahn1</strong></small>
    </footer>
    
    <script src="{{ url_for('static', filename='scripts/name-file.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/overlay-editor.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/export.js') }}"></script>
</body>
</html>